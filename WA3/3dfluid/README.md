# CUDA (GPU implementation)

## Table of Contents

1. [Project Structure](#project-structure)
2. [Requirements](#requirements)
3. [Installation](#installation)
4. [Usage](#usage)
   - [Generating Event Data](#generating-event-data)
   - [Running the Fluid Simulation](#running-the-fluid-simulation)
5. [Example](#example)

## Project Structure

```
├── README.md            # This file
├── events.txt           # Example event file (can be generated by Python script)
├── fluid_solver.h       # Header for fluid solver functions
├── fluid_solver.cpp     # Implementation of the fluid solver
├── fluid_solver.cu     # Implementation of the fluid solver with CUDA
├── EventManager.h       # Header for managing events (sources and forces)
├── EventManager.cpp     # Implementation for reading and applying events
├── main.cpp             # Main simulation logic that uses the fluid solver and EventManager
├── main.cu             # Main simulation logic that uses the fluid solver and EventManager with CUDA
├── generate_events.py   # Python script to generate events for the simulation
└── Makefile             # Makefile to compile the C++ simulation
└── cuda.sh             # Script to run the CUDA version in the backend of the cluster 
└── sequential.sh        # Script to run the sequential version in the backend of the cluster 
```

## Requirements

- **C++ Compiler**: The C++ code relies on the standard C++ library.
- **Python**: The Python script is used to generate event data for the fluid simulation.
- **CUDA**: API for parallel computing, GPGPU, and heterogeneous computing, created by Nvidia.

### Libraries and Tools
- Python
- Standard C++ libraries for compilation (e.g., `g++` or `clang++`).
- OpenMP library

## Installation

1. **Clone the repository**:
    ```bash
    git clone https://github.com/Diogo-Rodriigues/Optimization-with-parallelism-of-3d-fluid-simulation-code.git
    cd Optimization-with-parallelism-of-3d-fluid-simulation-code/WA3/3dfluid
    ```

2. **Compile the C++ Simulation**:
    Use the included `Makefile` to build the sequential or parallel version with CUDA of the C++ simulation .
    ```bash
    make seq
    ```
    ```bash
    make par
    ```

    This will generate an executable on `/share/apps/cuda/11.3.1/lib64` and in the current directory `fluid_sim` or `fluid_sim_seq`.

## Usage

### Generating Event Data

The Python script `generate_events.py` generates a file (`events.txt`) that specifies density sources and forces applied during specific timesteps. All events are generated with normalized vectors, and the simulation will apply them at the correct timestep.

1. **Run the Python script**:
    ```bash
    python generate_events.py
    ```

    This will create an `events.txt` file with 1000 timesteps, where sources are density values, and forces are applied in positive directions along the X, Y, or Z axes.

2. **Customize the Event Generation**:
    You can modify the script to generate different events by changing the number of events, the range of timesteps, or the magnitude of forces and densities.

### Running the Fluid Simulation

Once you've generated the `events.txt` file, you can run the fluid simulation, which will read the events and apply them over the course of the simulation.

1. **Run the sequential or parallel simulation in the SEARCH cluster**:
    ```bash
    make runseq
    ```
    ```bash
    make run
    ```
**Or run the sequential or parallel simulation localy (Be carefull since your PC needs to have a NVIDIA GPU)**:
   ```bash
   ./fluid_sim_seq
   ```
   ```bash
   ./fluid_sim
   ```
    
   The simulation will read the `events.txt` file, apply the specified sources and forces at the correct timesteps, and calculate the fluid dynamics.

2. **Simulation Output**:
    At the end of the simulation, the total density in the fluid field will be printed.

    Example output:
    ```
    Total density after 1000 timesteps: 3456.789000
    ```

## Example

### Generating Events

Here’s an example of how you can use the Python script to generate a file of events (`events.txt`):

```bash
python generate_events.py
```

This will generate an event file like the following:

```
1000
source 10 50
force 1 0 0 200
source 5 150
force 0 1 0 400
source 8 900
```

### Problems with the generator
If you are experiencing problems with the generator there is a events.txt file as an example in the root folder of the project.

### Running the Simulation

Once `events.txt` is generated, you can run the sequential or parallel fluid simulation using:
    
**Run the sequential or parallel simulation in the SEARCH cluster**:
   ```bash
   make runseq
   ```
   ```bash
   make run
   ```
**Or run the sequential or parallel simulation localy (Be carefull since your PC needs to have a NVIDIA GPU)**:
```bash
./fluid_sim_seq
```
```bash
./fluid_sim
```

The simulation will dynamically apply the sources and forces defined in `events.txt`, simulate the fluid behavior, and print the total density after 1000 timesteps.
